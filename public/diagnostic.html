<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rehabify Diagnostic</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font: 14px/1.5 ui-sans-serif, system-ui; margin: 20px; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 8px; border-radius: 8px; max-width: 820px; }
    video, canvas { width: 640px; height: 360px; background:#000; display:block; margin: 10px 0; }
    .ok { color: #16a34a; } .bad { color: #dc2626; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
</head>
<body>
  <h1>Rehabify Diagnostic</h1>
  <p>This page only tests camera + Mediapipe + your two JS files. If this works, your environment is good and any issue is in app logic.</p>

  <div id="log">Log:\n</div>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <button id="btn">Start Test</button>

  <!-- load your globals -->
  <script src="./criteria.js"></script>
  <script src="./exercises.js"></script>

  <script>
    const logEl = document.getElementById('log');
    function log(msg, ok) {
      const line = document.createElement('div');
      line.innerHTML = (ok === true ? '<b class="ok">✔</b> ' : ok === false ? '<b class="bad">✖</b> ' : '') + msg;
      logEl.appendChild(line);
      console.log(msg);
    }

    // Basic checks for your two files
    window.addEventListener('load', () => {
      log('Page loaded');
      log('criteria.js present: ' + (typeof window.CRITERIA === 'object'), typeof window.CRITERIA === 'object');
      log('exercises.js present: ' + (Array.isArray(window.exercises)), Array.isArray(window.exercises));
      if (Array.isArray(window.exercises)) {
        log('First exercise id: ' + (window.exercises[0]?.id ?? 'NONE'));
      }
      log('Pose constructor present: ' + (!!(window.Pose || (window.pose && window.pose.Pose))), !!(window.Pose || (window.pose && window.pose.Pose)));
    });

    document.getElementById('btn').addEventListener('click', async () => {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      try {
        log('Requesting camera…');
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:1280, height:720 }, audio:false });
        video.srcObject = stream;
        await new Promise(res => video.onloadedmetadata = res);
        video.play();
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        log('Camera OK', true);

        const PoseCtor = window.Pose || (window.pose && window.pose.Pose);
        if (!PoseCtor) { log('Pose constructor not found', false); return; }
        log('Pose ctor OK', true);

        const pose = new PoseCtor({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
        pose.setOptions({ modelComplexity:1, smoothLandmarks:true, minDetectionConfidence:0.5, minTrackingConfidence:0.5 });

        pose.onResults(({ poseLandmarks }) => {
          ctx.save(); ctx.scale(-1,1);
          ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
          ctx.restore();

          if (poseLandmarks) {
            log('Pose frame received (landmarks=' + poseLandmarks.length + ')', true);
          }
        });

        if (typeof Camera === 'function') {
          const cam = new Camera(video, {
            onFrame: async () => { await pose.send({ image: video }); },
            width: canvas.width, height: canvas.height
          });
          cam.start();
          log('Camera loop started', true);
        } else {
          log('Camera helper missing — using manual loop');
          (async function loop(){
            await pose.send({ image: video });
            requestAnimationFrame(loop);
          })();
        }
      } catch (e) {
        log('ERROR: ' + (e?.message || e), false);
        console.error(e);
      }
    });
  </script>
</body>
</html>
